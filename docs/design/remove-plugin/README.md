# Remove Plugin — Cleanup Plan

The Claude Code plugin is moving to its own repo. This document describes every
change needed to clean out the plugin from this (app) repo, including how to
handle the agent tests that are currently co-located with the plugin tests.

---

## What stays

These items were identified as app-only during review and must **not** be removed:

| Path | Why it stays |
|---|---|
| `agents/` | Sidecar loads agents via `agentName` in the SDK — app dependency |
| `agent-sources/` (entire directory) | App deploys `CLAUDE.md` as the workspace system prompt and deploys `skills/research`, `skills/validate-skill`, `skills/skill-builder-practices` into `.claude/skills/` — see `workflow.rs:resolve_bundled_skills_dir` |
| `docs/design/skills-marketplace/` | Documents the Tauri app's import/browse/update UI feature |
| `docs/design/agent-specs/` | Canonical artifact format — shared contract between agents and the Rust/TS parsers |

### Note: skill deployment runs on every workflow step

`deploy_skill_for_workflow` (called in `run_workflow_step`) re-deploys the three
bundled skills on every step. This differs from `ensure_workspace_prompts`
(agents + CLAUDE.md), which uses a session-scoped cache and copies only once per
workspace per session.

The per-step deployment exists to support a purpose-override feature: if the user
assigns a custom workspace skill to the research/validate/skill-building slot, the
next step picks it up without a restart. In practice, mid-session purpose switching
is not needed. The deployment should be simplified to use the same session cache
as `ensure_workspace_prompts` — invalidate on purpose assignment change in Settings,
deploy once otherwise. This is not a blocker for the plugin removal but should be
cleaned up separately.

---

## Deletions

### Directories

| Path | Reason |
|---|---|
| `skills/` | Built plugin output generated by `build-plugin-skill.sh`. No app code reads from here. |
| `.claude-plugin/` | Plugin manifest (`plugin.json`, `marketplace.json`). |
| `app/plugin-tests/` | All five test files — see Test Restructuring below. |
| `docs/design/plugin/` | Plugin architecture design docs. |
| `scripts/eval/` | Skill quality evaluation harness — plugin-only tooling. |

### Files

| Path | Reason |
|---|---|
| `CLAUDE-PLUGIN.md` | Plugin-specific conventions. |
| `app/vitest.config.plugin.ts` | Vitest config for plugin tests. Replaced by `vitest.config.agent.ts` (see below). |
| `scripts/build-plugin-skill.sh` | Packages `agent-sources/workspace/skills/` into `skills/`. |

---

## Test restructuring

`app/plugin-tests/` currently mixes two concerns. Only the agent tests belong in
this repo. The rest move to the plugin repo.

### What moves to the plugin repo

These tests exercise the coordinator skill via `claude --plugin-dir`. They require
`skills/`, `.claude-plugin/`, and the coordinator SKILL.md — all of which are
leaving this repo.

| File | What it tests |
|---|---|
| `structural.test.ts` (plugin.json, coordinator skill, reference files, claude plugin validate sections) | Plugin manifest and coordinator file structure |
| `plugin-loading.test.ts` | Coordinator loads and responds via CLI |
| `mode-detection.test.ts` | Coordinator state detection and intent dispatch |
| `workflow.test.ts` | Full end-to-end pipeline via CLI |

The full `structural.test.ts`, `helpers.ts`, `fixtures.ts`, and `vitest.config.plugin.ts`
also move to the plugin repo as-is (the plugin repo will use all of them).

### What stays in this repo (renamed and restructured)

Two concerns from `plugin-tests/` are genuine agent tests with no coordinator
dependency:

**1. Agent structure** (from `structural.test.ts` — three describe blocks):

- `agent files` — agents exist, have YAML frontmatter, correct model tiers
- `canonical format compliance` — agents contain no anti-patterns
- `validate.sh` — structural validation script passes

These make no API calls, do not invoke the claude CLI, and have no dependency on
`skills/` or `.claude-plugin/`. They are the free structural guard for `agents/`.

**2. Agent smoke tests** (all of `agent-smoke.test.ts`):

- `research-orchestrator` — writes `clarifications.md`
- `answer-evaluator` — writes `answer-evaluation.json`
- `confirm-decisions` — writes `decisions.md`
- `refine-skill` — updates SKILL.md frontmatter

These invoke agents **standalone via `-p`** (no `--plugin-dir`), injecting
workspace context and agent instructions directly into the prompt. The only
changes needed to make them fully independent:

- `PLUGIN_DIR` reference for `WORKSPACE_CONTEXT` → read from
  `agent-sources/workspace/CLAUDE.md` (same file the app deploys as the system prompt)
- `runClaude` (uses `--plugin-dir`) → `runAgent` (uses `-p` only)
- Move module-level `fs.readFileSync` calls (lines 19–26) into `beforeAll` —
  currently they throw at import time if files are missing instead of failing
  as a proper test

### New layout in this repo

```text
app/agent-tests/
├── helpers.ts                 ← REPO_ROOT, AGENTS_DIR, HAS_API_KEY, parseBudget, makeTempDir, runAgent
├── fixtures.ts                ← copy from plugin-tests/ unchanged (used by smoke tests)
├── agent-structure.test.ts    ← agent files + canonical format + validate.sh
└── agent-smoke.test.ts        ← 4 agent describes; runAgent, WORKSPACE_CONTEXT from agent-sources/
app/vitest.config.agent.ts     ← include: agent-tests/**/*.test.ts
```

### Script renames

| Old | New |
|---|---|
| `test:plugin` | `test:agents` |
| `test:plugin:structural` | `test:agents:structural` |
| `test:plugin:agents` | `test:agents:smoke` |
| `test:plugin:loading` | *(removed — plugin repo only)* |
| `test:plugin:modes` | *(removed — plugin repo only)* |
| `test:plugin:workflow` | *(removed — plugin repo only)* |

`test:agents:structural` remains free (no API calls, no claude binary needed).
`test:agents:smoke` requires `ANTHROPIC_API_KEY` or `FORCE_PLUGIN_TESTS=1`.

---

## File updates

### `CLAUDE.md`

- Remove `@import CLAUDE-PLUGIN.md`
- Remove the plugin column from the "Shared Components" table
- Remove the "Testing — plugin" dev commands block
- Remove the CLI Plugin rows from the test runner table
- Remove the `test:plugin*` references in the "Choosing which tests to run" table
- Replace with `test:agents:structural` and `test:agents:smoke` entries pointing to `agents/`

### `app/package.json`

- Remove `test:plugin`, `test:plugin:structural`, `test:plugin:loading`, `test:plugin:modes`, `test:plugin:agents`, `test:plugin:workflow`
- Add `test:agents`, `test:agents:structural`, `test:agents:smoke`
- Add `vitest.config.agent.ts` to config references

### `app/tests/run.sh`

- Rename `plugin` level → `agents`
- Rename `run_plugin()` → `run_agents()`
- Update script calls from `test:plugin` → `test:agents`
- Remove the workflow opt-in (`./tests/run.sh plugin workflow`) — that lives in the plugin repo

### `app/tests/TEST_MANIFEST.md`

- Rename "CLI Plugin" section → "Agents"
- Update source-to-test mapping:
  - `agents/*.md` → `test:agents:structural`, `test:agents:smoke`
  - `agent-sources/workspace/CLAUDE.md` → `test:agents:structural`
  - Remove rows for `skills/`, `.claude-plugin/plugin.json`
- Update cross-boundary compliance table: `test:plugin:structural` → `test:agents:structural`
- Update Quick Reference block

### `docs/design/README.md`

- Remove `plugin/` row
- Add `remove-plugin/` row (this doc)

### `.github/workflows/plugin.yml`

- Delete entirely (plugin CI moves to plugin repo)

---

## Order of operations

1. Write new `app/agent-tests/` files and `vitest.config.agent.ts`
2. Verify `npm run test:agents:structural` passes (free, no API)
3. Update `app/package.json` scripts
4. Update `app/tests/run.sh` and `TEST_MANIFEST.md`
5. Update `CLAUDE.md`
6. Delete `app/plugin-tests/`, `app/vitest.config.plugin.ts`
7. Delete `skills/`, `.claude-plugin/`, `CLAUDE-PLUGIN.md`
8. Delete `scripts/build-plugin-skill.sh`, `scripts/eval/`, `docs/design/plugin/`
9. Delete `.github/workflows/plugin.yml`
10. Update `docs/design/README.md`
11. Run `markdownlint '**/*.md'` — verify clean
12. Run `./tests/run.sh unit` — verify no regressions
